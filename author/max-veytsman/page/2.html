<!DOCTYPE html>
<html>
<head>
<title>Appcanary</title>
<meta content='&lt;a href="https://appcanary.com"&gt;Appcanary&lt;/a&gt; makes sure you never run vulnerable software in your apps.&lt;br/&gt;Subscribe to our &lt;a href="https://appcanary.us10.list-manage.com/subscribe?u=303b378f377508300c0b5469a&amp;id=dc58e8f56f"&gt;newsletter&lt;/a&gt;!' name='description'>
<meta charset='utf-8'>
<meta content='width=device-width, initial-scale=1.0' name='viewport'>
<meta content='IE=edge' http-equiv='X-UA-Compatible'>
<meta content='True' name='HandheldFriendly'>
<meta content='Appcanary' property='og:site_name'>
<meta content='website' property='og:type'>
<meta content='&lt;a href="https://appcanary.com"&gt;Appcanary&lt;/a&gt; makes sure you never run vulnerable software in your apps.&lt;br/&gt;Subscribe to our &lt;a href="https://appcanary.us10.list-manage.com/subscribe?u=303b378f377508300c0b5469a&amp;id=dc58e8f56f"&gt;newsletter&lt;/a&gt;!' property='og:description'>
<meta content='http://blog.appcanary.com/author/max-veytsman/page/2.html' property='og:url'>
<meta content='http://blog.appcanary.com/images/appcanary.png' property='og:image'>
<meta content='summary' name='twitter:card'>
<meta content='&lt;a href="https://appcanary.com"&gt;Appcanary&lt;/a&gt; makes sure you never run vulnerable software in your apps.&lt;br/&gt;Subscribe to our &lt;a href="https://appcanary.us10.list-manage.com/subscribe?u=303b378f377508300c0b5469a&amp;id=dc58e8f56f"&gt;newsletter&lt;/a&gt;!' name='twitter:description'>
<meta content='http://blog.appcanary.com/author/max-veytsman/page/2.html' name='twitter:url'>
<meta content='http://blog.appcanary.com/images/appcanary.png' name='twitter:image:src'>
<link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
<link href="/images/favicon.ico" rel="icon" type="image/ico" />
<link href="../../../stylesheets/application.css" rel="stylesheet" />
<script src="//use.typekit.net/dkz5zwp.js"></script>
<script>try{Typekit.load({ async: false });}catch(e){}</script>

</head>
<body class='archive-template nav-closed'>
<div class='topbar'></div>
<div class='nav'>
<h3 class='nav-title'>Menu</h3>
<a class='nav-close' href='#'>
<span class='hidden'>Close</span>
</a>
<ul>
<li class='nav-home' role='presentation'>
<a href='/'>Home</a>
</li>
<li class='nav-archive' role='presentation'>
<a href='archive.html'>Archive</a>
</li>
<li class='nav-github' role='presentation'>
<a href='https://github.com/appcanary'>Github</a>
</li>
</ul>
<a class='subscribe-button icon-feed' href='/feed.xml'>Subscribe</a>
</div>
<span class='nav-cover'></span>

<div class='site-wrapper'>
<header class='main-header no-cover'>
<nav class='main-nav overlay clearfix'>
</nav>
<div class='vertical'>
<div class='main-header-content inner'>
<a class='appcanary-logo' href='/'>
<img alt="Appcanary" src="../../../images/appcanary.png" />
</a>
<h2 class='page-description'><a href="https://appcanary.com">Appcanary</a> makes sure you never run vulnerable software in your apps.<br/>Subscribe to our <a href="https://appcanary.us10.list-manage.com/subscribe?u=303b378f377508300c0b5469a&id=dc58e8f56f">newsletter</a>!</h2>
<div class='more-icons'>
<a alt='Twitter' href='https://twitter.com/appcanary' title='Twitter'>
<i class='fa fa-twitter-square'></i>
</a>
<a alt='Github' href='https://github.com/appcanary' title='Github'>
<i class='fa fa-github-square'></i>
</a>
<a alt='Archive' href='/archive.html' title='Archive'>
<i class='fa fa-archive'></i>
</a>
<a alt='Feed' href='/feed.xml' title='Feed'>
<i class='fa fa-rss-square'></i>
</a>
</div>
</div>
</div>
<a class='scroll-down icon-arrow-left' data-offset='-45' href='#content'>
<span class='hidden'>Scroll Down</span>
</a>
</header>

<section class='author-profile inner'>
<h1 class='author-title'>Max Veytsman</h1>
<div class='author-meta'>
<span class='author-stats'>
<i class='icon-stats'></i>
10 posts
</span>
</div>
</section>
<main class='content' id='content' role='main'>
<div class='extra-pagination inner'>
<nav class='pagination' role='pagination'>
<a class="newer-posts" href="../../max-veytsman.html">← Newer Posts</a>
<span class='page-number'>Page 2 of 3</span>
<a class="older-posts" href="3.html">Older Posts →</a>
</nav>

</div>
<article class='post'>
<header class='post-header'>
<h1 class='post-title'><a href="../../../2016/two-new-apis.html">Two new APIs from Appcanary</a></h1>
<section class='post-meta'>
</section>
</header>
<section class='post-content'>
<p>After the success of our <a href="http://blog.appcanary.com/2016/new-api-centos-support.html">check</a> API, we found that our users told us:</p>

<blockquote>
<p>&ldquo;I love your API so much! But can I use it register the packages my app uses and get emailed if new vulnerabilities that affect me come out? Oh, and it would be nice if I could pragmatically query the servers I have agents running on too!&rdquo;</p>
</blockquote>

<p>So we went ahead and built both.</p>

<h2>The Monitor API</h2>

<p>The &ldquo;Monitor&rdquo; API lets you register a Gemfile or an Ubuntu/CentOS package list to be emailed when new vulnerabilities are discovered. It like what our agent does, but in situations where it doesn&rsquo;t make sense like when you use Docker or deploy on a PaaS like Heroku.</p>

<p>You can register a new monitor by:</p>
<pre class="highlight shell"><code>curl -H <span class="s2">"Authorization: Token YOURTOKENHERE"</span> <span class="se">\</span>
     -X POST -F <span class="nv">file</span><span class="o">=</span>@./Gemfile.lock <span class="se">\</span>
     https://appcanary.com/api/v2/monitors/my-great-app?platform<span class="o">=</span>ruby
</code></pre>

<p>and you&rsquo;ll get a response like:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"monitor"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-server"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"uuid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"56eac124-35c2-49bd-ab02-45de56c03ef4"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"vulnerable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>And, you&rsquo;ll be emailed about any vulnerabilities that affect your app as soon as we find out about them!</p>

<p>You can also list, inspect, or delete monitors via the API. More information <a href="https://appcanary.com/docs#create-monitor">here</a>.</p>

<h2>The Server API</h2>

<p>The &ldquo;Server&rdquo; API allows you to navigate the servers you have the Appcanary agent running on via API, and list any vulnerabilities that affect them!</p>

<p>I can see the servers I have agents running on with:
<code>bash
curl -H &quot;Authorization: Token YOURTOKENHERE&quot; \
      https://appcanary.com/api/v2/servers
</code></p>

<p>and you&rsquo;ll get a response like:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"server"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"server1"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"uuid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"55a5baeb-2ad4-4787-8784-a062d254900e"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"hostname"</span><span class="p">:</span><span class="w"> </span><span class="s2">"server1"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"last-heartbeat-at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2016-03-27T03:33:02.185Z"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"vulnerable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nt">"apps"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"app"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
              </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/var/lib/dpkg/status"</span><span class="p">,</span><span class="w">
              </span><span class="nt">"uuid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"55a5baec-3e5c-4cca-832c-06aaa36418f6"</span><span class="p">,</span><span class="w">
              </span><span class="nt">"vulnerable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"app"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
              </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/var/www/myapp/current/Gemfile.lock"</span><span class="p">,</span><span class="w">
              </span><span class="nt">"uuid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"55a5baec-027d-4618-b8de-12638281f34c"</span><span class="p">,</span><span class="w">
              </span><span class="nt">"vulnerable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"server"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"server2"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"uuid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"560b0e75-1317-481c-98bb-15e6ae5978b6"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"hostname"</span><span class="p">:</span><span class="w"> </span><span class="s2">"database"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"last-heartbeat-at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2016-03-08T00:21:31.105Z"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"vulnerable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nt">"apps"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"app"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
              </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/var/lib/dpkg/status"</span><span class="p">,</span><span class="w">
              </span><span class="nt">"uuid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"560b0e77-0a26-41fd-bc35-38b5aac33709"</span><span class="p">,</span><span class="w">
              </span><span class="nt">"vulnerable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>You can also inspect or delete any server with an agent on it via the API.</p>

<p>Our API fully supports <strong>Ruby</strong>, <strong>Ubuntu</strong>, and <strong>CentOS 7</strong>! Learn more about how to use it by visiting <a href="https://appcanary.com/docs">the docs page</a>.</p>

<p>You can <a href="https://appcanary.com/sign_up">sign up</a> for Appcanary to use our APIs today!</p>

</section>
<footer class='post-meta'>
<a href='/author/max-veytsman.html'>Max Veytsman</a>
on <a href='/tag/announcements.html'>Announcements</a>, <a href='/tag/product.html'>Product</a>
<time class='post-date' datetime='2016-04-06'>
06 April 2016
</time>
</footer>
</article>
<article class='post'>
<header class='post-header'>
<h1 class='post-title'><a href="../../../2016/new-api-centos-support.html">Hello, new Appcanary API and CentOS support!</a></h1>
<section class='post-meta'>
</section>
</header>
<section class='post-content'>
<p>A lot of our users have told us, </p>

<blockquote>
<p>&ldquo;Gosh, I love knowing exactly which packages I have to update in order to keep my apps and servers secure. Have you thought about an API?&rdquo;</p>
</blockquote>

<p>We listened carefully to that feedback, and it is with pride and pleasure that we&rsquo;re announcing our new beta! We&rsquo;re still busy improving it, so we won&rsquo;t charge you for it for now.</p>

<p>Once you <a href="https://appcanary.com/sign_up">sign up</a>, all you have to do is issue a curl:</p>
<pre class="highlight shell"><code>curl -H <span class="s2">"Authorization: Token YOURTOKENHERE"</span> <span class="se">\</span>
     -X POST -F <span class="nv">file</span><span class="o">=</span>@./Gemfile.lock <span class="se">\</span>
     https://appcanary.com/api/v2/check/ruby
</code></pre>

<p>and you&rsquo;ll get a response like:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"vulnerable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"artifact-version"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rack"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"kind"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rubygem"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"number"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.6.0"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"vulnerabilities"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nt">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Potential Denial of Service Vulnerability in Rack"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Carefully crafted requests can cause a `SystemStackError` and potentially \ncause a denial of service attack. \n\nAll users running an affected release should upgrade."</span><span class="p">,</span><span class="w">
            </span><span class="nt">"criticality"</span><span class="p">:</span><span class="w"> </span><span class="s2">"high"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"cve"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="s2">"CVE-2015-3225"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nt">"osvdb"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
            </span><span class="nt">"patched-versions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="s2">"~&lt; 1.5.4"</span><span class="p">,</span><span class="w">
              </span><span class="s2">"~&lt; 1.4.6"</span><span class="p">,</span><span class="w">
              </span><span class="s2">"&gt;= 1.6.2"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nt">"unaffected-versions"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
            </span><span class="nt">"uuid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"55807540-053f-40f0-9266-a3d1ca6a5838"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"upgrade-to"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="s2">"&gt;= 1.6.2"</span><span class="w">
            </span><span class="p">]</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>Our API fully supports <strong>Ruby</strong>, <strong>Ubuntu</strong>, and <strong>CentOS 7</strong>! You can learn more about how to use it by visiting <a href="https://appcanary.com/docs">the docs page</a>.</p>

<p>Which reminds us,</p>

<h2>We now support CentOS 7!</h2>

<p>Appcanary now fully supports <strong>CentoOS 7</strong>. If you install our agent on a CentOS 7 server, we will email you notifications whenever any rpm package you have installed on your system has a known vulnerability.</p>

<p>If you&rsquo;re not a current user and want to try out Appcanary&rsquo;s API and/or use us to monitor your CentOS 7 servers, you can <a href="https://appcanary.com/signup">sign up</a>!</p>

<p>You can always let us know what you think at <a href="mailto:hello@appcanary.com">hello@appcanary.com</a>.</p>

</section>
<footer class='post-meta'>
<a href='/author/max-veytsman.html'>Max Veytsman</a>
on <a href='/tag/announcements.html'>Announcements</a>, <a href='/tag/product.html'>Product</a>
<time class='post-date' datetime='2016-03-07'>
07 March 2016
</time>
</footer>
</article>
<article class='post'>
<header class='post-header'>
<h1 class='post-title'><a href="../../../2016/datomic-intro-talk.html">A Gentle Intro to Datomic</a></h1>
<section class='post-meta'>
</section>
</header>
<section class='post-content'>
<p>We use <a href="http://www.datomic.com/">Datomic</a> as one of our datastores, and have been really enjoying it so far.</p>

<p>I gave a talk to my local <a href="http://www.meetup.com/Clojure-Toronto/">Clojure meetup</a> that provided a gentle introduction to Datomic and highlighted some cool features.</p>

<p>The slides are below:</p>

<script async="" class="speakerdeck-embed" data-id="dd426e5c924f44eb9050c554137ae030" data-ratio="1.77777777777778" src="//speakerdeck.com/assets/embed.js"></script>

</section>
<footer class='post-meta'>
<a href='/author/max-veytsman.html'>Max Veytsman</a>
on <a href='/tag/clojure.html'>Clojure</a>, <a href='/tag/datomic.html'>Datomic</a>, <a href='/tag/programming.html'>Programming</a>, <a href='/tag/talks.html'>Talks</a>
<time class='post-date' datetime='2016-02-09'>
09 February 2016
</time>
</footer>
</article>
<article class='post'>
<header class='post-header'>
<h1 class='post-title'><a href="../../../2016/state-management-downtime.html">How being lazy about state management in Clojure caused us downtime</a></h1>
<section class='post-meta'>
</section>
</header>
<section class='post-content'>
<p>On November 10th, we suffered some downtime as our backend application mysteriously crashed and had to be restarted. After looking at our process monitoring service, I found a very suspicious graph:</p>

<p><img alt="image" src="../../../images/system.process.threads.png" /></p>

<p>Somehow, we managed to spin up more then 30,000 threads right before the application crashed. This was very likely the cause of the failure, but how did it happen?</p>

<p>An easy way to get an idea of where a thread leak is coming from is to look at the thread names. In Java you can do this with <code>jstack -l $PID</code>.</p>

<p>To get a list of all thread names of a Java application sorted by most common name, you can do:</p>
<pre class="highlight plaintext"><code>jstack -l $PID | grep daemon |  awk '{ print $1 }' | sort | uniq -c |   sort -nr
</code></pre>

<p>Which on our end yielded something like this:</p>
<pre class="highlight plaintext"><code>  30000 "Analytics"
      2 "Datomic
      2 "C2
      1 "worker-4"
      1 "worker-3"
      1 "worker-2"
      1 "worker-1"
      1 "Timer-0"
      1 "Thread-5"
      1 "Thread-4
      1 "Thread-3
      1 "Thread-2
      1 "Thread-1
      1 "Thread-0
</code></pre>

<p>Hmm&hellip;</p>

<h3>Background</h3>

<p>Our backend is written in Clojure and we use Stuart Sierra&rsquo;s <a href="https://github.com/stuartsierra/component">component</a> framework to manage most of our application&rsquo;s state and lifecycle. Normally this should prevent runaway threads, but unfortunately for us our analytics client&rsquo;s state was managed independently of the framework. To explain why, I need to first delve a little in to how component works.</p>

<p>Regardless of how beautiful and functional it may be, any application that talks to the outside world will need to manage some state representing these external resources. We need to manage our database connections, our clients for external APIs, our background workers, etc.</p>

<p>One way to deal with this in Clojureland is to create a global singleton object for representing each stateful piece, possibly wrapped in an <code>atom</code>. This feels lacking, though. You still need a way to initialize all these singletons on startup, and having mutable singletons everywhere goes against what I would consider good Clojure style.</p>

<p>Component solves this problem by implementing dependency injection in a Clojurelike way. You define a graph that represents each stateful piece, how they depend on each other, and how each piece starts and stops. On system start, component boots each piece in the right order, passing along references to dependencies when they&rsquo;re needed.</p>

<p>For example, Appcanary&rsquo;s dependency graph looks (something) like this:</p>
<pre class="highlight clojure"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">canary-system</span><span class="w">
  </span><span class="p">[]</span><span class="w">
  </span><span class="c1">;;Initialize logging
</span><span class="w">  </span><span class="p">(</span><span class="nf">component/system-map</span><span class="w">
   </span><span class="no">:datomic</span><span class="w"> </span><span class="p">(</span><span class="nf">new-datomic</span><span class="w"> </span><span class="p">(</span><span class="nf">env</span><span class="w"> </span><span class="no">:datomic-uri</span><span class="p">))</span><span class="w">
   </span><span class="no">:scheduler</span><span class="w"> </span><span class="p">(</span><span class="nf">new-scheduler</span><span class="p">)</span><span class="w">
   </span><span class="no">:mailer</span><span class="w"> </span><span class="p">(</span><span class="nf">component/using</span><span class="w">  </span><span class="p">(</span><span class="nf">new-mailer</span><span class="w"> </span><span class="p">(</span><span class="nf">env</span><span class="w"> </span><span class="no">:mandrill-key</span><span class="p">))</span><span class="w">
                             </span><span class="p">[</span><span class="no">:datomic</span><span class="w"> </span><span class="no">:scheduler</span><span class="p">])</span><span class="w">
   </span><span class="no">:web-server</span><span class="w"> </span><span class="p">(</span><span class="nf">component/using</span><span class="w"> </span><span class="p">(</span><span class="nf">new-web-server</span><span class="w"> </span><span class="p">(</span><span class="nf">env</span><span class="w"> </span><span class="no">:http-ip</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">Integer.</span><span class="w"> </span><span class="p">(</span><span class="nf">env</span><span class="w"> </span><span class="no">:http-port</span><span class="p">))</span><span class="w"> </span><span class="n">canary-api</span><span class="p">)</span><span class="w">
                             </span><span class="p">[</span><span class="no">:datomic</span><span class="p">])))</span><span class="w">
</span></code></pre>

<p>The <code>mailer</code> depends on <code>datomic</code> and the <code>scheduler</code>, the web server depends on <code>datomic</code>, and both <code>datomic</code> and the <code>scheduler</code> don&rsquo;t depend on anything.</p>

<p>Like all the other components, the <code>new-datomic</code> function is a constructor for a record that knows how to start and stop itself. On system start, all the components are started, and the dependencies are filled in.</p>

<h3>Sometimes component feels like overkill</h3>

<p>Component is great, but it didn&rsquo;t fit our analytics engine usecase. We use <a href="https://segment.io">segment.io</a> to handle our app analytics, and we needed to maintain a client to talk to it. An analytics event can potentially be called from anywhere in the app, but it&rsquo;s cumbersome to pass an analytics client reference to every component, and into every analytics call. If every component depends on something, it feels like maybe it should be a global singleton. Futhermore, I don&rsquo;t want my components to know much about the analytics client at all; I just want them to know how to trigger events.</p>

<p>What I want to have is an analytics namespace which contains all the events I may want to trigger, and wraps the client inside all of them. This lets me  do something like <code>(analytics/user-added-server user)</code> inside of the code that handles server creation.</p>

<p>(One thing to note is that while there is a clojure segment.io <a href="https://github.com/ardoq/analytics-clj">client</a>, it&rsquo;s based off a 1.x release of the underlying <a href="https://github.com/segmentio/analytics-java">java library</a>, while we wanted to use features only available in the 2.0 release. Because of that, I wrote an analytics namespace that called the java library directly).</p>

<p>The first pass of creating the client looked something like this:</p>
<pre class="highlight clojure"><code><span class="p">(</span><span class="nf">defonce</span><span class="w"> </span><span class="n">client</span><span class="w">
  </span><span class="p">(</span><span class="nf">.build</span><span class="w"> </span><span class="p">(</span><span class="nf">Analytics/builder</span><span class="w"> </span><span class="p">(</span><span class="nf">env</span><span class="w"> </span><span class="no">:segment-api-key</span><span class="p">))))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">track</span><span class="w">
  </span><span class="s">"Wrapper for analytics/track"</span><span class="w">
  </span><span class="p">[</span><span class="n">id</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="n">properties</span><span class="w"> </span><span class="p">{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">timestamp</span><span class="p">]</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">options</span><span class="p">}]</span><span class="w">
  </span><span class="p">(</span><span class="nb">when</span><span class="w"> </span><span class="p">(</span><span class="nf">production?</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">.enqueue</span><span class="w"> </span><span class="n">client</span><span class="w">
              </span><span class="c1">;; Java interop to build the analytics message here)))
</span></code></pre>

<p>There&rsquo;s only one problem with the above code: the segment api key is loaded from an environment variable. </p>

<p>We deploy appcanary in a pretty standard way &ndash; we compile an uberjar and rsync it to the server. API keys live in environment variables, and the production API key is only going to live on the production server. So, at compile time, we have no way of knowing what the segment api key is. As a result, the analytics client needs to be built at runtime and not compile time in order to have access to the api key.</p>

<h3>This is where I get lazy</h3>

<p>The obvious thing to do to build the analytics client at runtime is to wrap it as a function:</p>
<pre class="highlight clojure"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">client</span><span class="w">
  </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="nf">.build</span><span class="w"> </span><span class="p">(</span><span class="nf">Analytics/builder</span><span class="w"> </span><span class="p">(</span><span class="nf">env</span><span class="w"> </span><span class="no">:segment-api-key</span><span class="p">))))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">track</span><span class="w">
  </span><span class="s">"Wrapper for analytics/track"</span><span class="w">
  </span><span class="p">[</span><span class="n">id</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="n">properties</span><span class="w"> </span><span class="p">{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">timestamp</span><span class="p">]</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">options</span><span class="p">}]</span><span class="w">
  </span><span class="p">(</span><span class="nb">when</span><span class="w"> </span><span class="p">(</span><span class="nf">production?</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">.enqueue</span><span class="w"> </span><span class="p">(</span><span class="nf">client</span><span class="p">)</span><span class="w">
              </span><span class="c1">;; Java interop to build the analytics message here)))
</span></code></pre>

<p>I saw three downsides here:</p>

<ol>
<li>We&rsquo;ll lose some efficiency from not reusing the TCP connection to segment.io</li>
<li>It&rsquo;s possible that we&rsquo;ll have to waste a bit of time authenticating the analytics client on each call</li>
<li>We&rsquo;ll spawn an extra client object per call, which will be garbage collected right away as it goes out of scope immediately after the <code>track</code> call</li>
</ol>

<p>The above three things aren&rsquo;t intrinsically bad, and it seemed like optimizing the performance of your analytics engine early on was a wasteful thing to do in a fast-paced startup environment.</p>

<p>What I didn&rsquo;t consider is that the java library uses <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ExecutorService.html"><code>ExecutorService</code></a> to manage a threadpool, and <code>shutdown</code> must be called explicitly. Otherwise, the threads are put on hold instead of being marked for GC (see also <a href="http://stackoverflow.com/questions/16122987/reason-for-calling-shutdown-on-executorservice">this stackoverflow</a>).</p>

<p>The fact that each client spawns a thread that isn&rsquo;t cleaned up by garbage collection was not <a href="https://segment.com/docs/libraries/java/">documented</a> unfortunately.</p>

<h3>Outcome</h3>

<p>Every analytics call we made spawned another threadpool, which caused the thread count to grow proportionally with user activity. We hit 40,000 threads before our application crashed.</p>

<h3>TL;DR:</h3>

<p>We spawned a new client object on every analytics call, not realizing that the underlying library uses a thread pool that&rsquo;s not shutdown on garbage collection. This is how we ended up killing the server by hitting 40,000 threads</p>

</section>
<footer class='post-meta'>
<a href='/author/max-veytsman.html'>Max Veytsman</a>
on <a href='/tag/clojure.html'>Clojure</a>, <a href='/tag/programming.html'>Programming</a>, <a href='/tag/developer-diary.html'>Developer Diary</a>, <a href='/tag/bugs.html'>Bugs</a>
<time class='post-date' datetime='2016-02-02'>
02 February 2016
</time>
</footer>
</article>
<nav class='pagination' role='pagination'>
<a class="newer-posts" href="../../max-veytsman.html">← Newer Posts</a>
<span class='page-number'>Page 2 of 3</span>
<a class="older-posts" href="3.html">Older Posts →</a>
</nav>


</main>

<footer class='site-footer clearfix'>
<section class='copyright'>
<a href='/'>Appcanary</a>
&copy;
2016
</section>
<section class='poweredby'>
</section>
</footer>
</div>
<script src="../../../javascripts/application.js"></script>
<script type="text/javascript">
 /* <![CDATA[ */
 var google_conversion_id = 928841383;
 var google_custom_params = window.google_tag_params;
 var google_remarketing_only = true;
 /* ]]> */
</script>

<script type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js">
</script>
<noscript>
    <div style="display:inline;">
        <img height="1" width="1" style="border-style:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/928841383/?value=0&amp;guid=ON&amp;script=0"/>
    </div>
</noscript>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61163522-3', 'auto');
  ga('send', 'pageview');

</script>

<!-- Twitter universal website tag code -->
<script>
 !function(e,n,u,a){e.twq||(a=e.twq=function(){a.exe?a.exe.apply(a,arguments):
                                               a.queue.push(arguments);},a.version='1',a.queue=[],t=n.createElement(u),
                            t.async=!0,t.src='//static.ads-twitter.com/uwt.js',s=n.getElementsByTagName(u)[0],
                            s.parentNode.insertBefore(t,s))}(window,document,'script');
 // Insert Twitter Pixel ID and Standard Event data below
 twq('init','nve06');
 twq('track','PageView');
</script>
<!-- End Twitter universal website tag code -->

</body>
</html>
