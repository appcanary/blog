<!DOCTYPE html>
<html>
<head>
<title>Ruby - Appcanary</title>
<meta content='&lt;a href="https://appcanary.com"&gt;Appcanary&lt;/a&gt; makes sure you never run vulnerable software on your servers.&lt;br/&gt;Subscribe to our &lt;a href="https://appcanary.us10.list-manage.com/subscribe?u=303b378f377508300c0b5469a&amp;id=dc58e8f56f"&gt;newsletter&lt;/a&gt;!' name='description'>
<meta charset='utf-8'>
<meta content='width=device-width, initial-scale=1.0' name='viewport'>
<meta content='IE=edge' http-equiv='X-UA-Compatible'>
<meta content='True' name='HandheldFriendly'>
<meta content='Appcanary' property='og:site_name'>
<meta content='website' property='og:type'>
<meta content='Ruby' property='og:title'>
<meta content='&lt;a href="https://appcanary.com"&gt;Appcanary&lt;/a&gt; makes sure you never run vulnerable software on your servers.&lt;br/&gt;Subscribe to our &lt;a href="https://appcanary.us10.list-manage.com/subscribe?u=303b378f377508300c0b5469a&amp;id=dc58e8f56f"&gt;newsletter&lt;/a&gt;!' property='og:description'>
<meta content='http://blog.appcanary.com/tag/ruby.html' property='og:url'>
<meta content='http://blog.appcanary.com/images/appcanary.png' property='og:image'>
<meta content='summary' name='twitter:card'>
<meta content='Ruby' name='twitter:title'>
<meta content='&lt;a href="https://appcanary.com"&gt;Appcanary&lt;/a&gt; makes sure you never run vulnerable software on your servers.&lt;br/&gt;Subscribe to our &lt;a href="https://appcanary.us10.list-manage.com/subscribe?u=303b378f377508300c0b5469a&amp;id=dc58e8f56f"&gt;newsletter&lt;/a&gt;!' name='twitter:description'>
<meta content='http://blog.appcanary.com/tag/ruby.html' name='twitter:url'>
<meta content='http://blog.appcanary.com/images/appcanary.png' name='twitter:image:src'>
<link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
<link href="/images/favicon.ico" rel="icon" type="image/ico" />
<link href="//blog.appcanary.com/stylesheets/application.css" rel="stylesheet" />
<script src="//use.typekit.net/dkz5zwp.js"></script>
<script>try{Typekit.load({ async: false });}catch(e){}</script>

</head>
<body class='post-template home-post-template nav-closed'>
<div class='topbar'></div>
<div class='nav'>
<h3 class='nav-title'>Menu</h3>
<a class='nav-close' href='#'>
<span class='hidden'>Close</span>
</a>
<ul>
<li class='nav-home' role='presentation'>
<a href='/'>Home</a>
</li>
<li class='nav-archive' role='presentation'>
<a href='archive.html'>Archive</a>
</li>
<li class='nav-github' role='presentation'>
<a href='https://github.com/appcanary'>Github</a>
</li>
</ul>
<a class='subscribe-button icon-feed' href='/tag/ruby.htmlfeed.xml'>Subscribe</a>
</div>
<span class='nav-cover'></span>

<div class='site-wrapper'>
<header class='main-header no-cover tag-head'>
<nav class='main-nav overlay clearfix'>
<a class='blog-logo' href='/'>
<img alt="Appcanary" src="//blog.appcanary.com/images/appcanary.png" />
</a>
</nav>
<div class='vertical'>
<div class='main-header-content inner'>
<h1 class='page-title'>Ruby</h1>
<h2 class='page-description'>A 3-post collection</h2>
</div>
</div>
</header>
<main class='content' id='content' role='main'>
<div class='extra-pagination inner'>
<nav class='pagination' role='pagination'>
<span class='page-number'>Page 1 of 1</span>
</nav>

</div>
<article class='post'>
<header class='post-header'>
<h1 class='post-title'><a href="../2016/unattended-upgrades.html">Good News: Ubuntu Now Ships With unattended-upgrades On By Default!</a></h1>
<section class='post-meta'>
</section>
</header>
<section class='post-content'>
<p>Last week, we got a strange support request. One of our users had received the following notification:</p>

<blockquote>
<p>Hey! Good job.</p>

<p>We&rsquo;ve detected that you patched some vulnerabilities.</p>

<p>Here&rsquo;s what changed:</p>

<p><a href="https://appcanary.com/vulns/46220">CVE-2016-8704</a></p>

<p>is no longer present in:</p>

<p>[name of server redacted]</p>
</blockquote>

<p>This came as a surprise, since they knew for a fact that no one had touched the package in
question, and they were certain they had not enabled unattended upgrades. </p>

<p>Somehow, the vulnerability magically got patched and they wanted to
know: what&rsquo;s going on?</p>

<p>The vuln is a pretty serious remote code execution vulnerability in <code>memcached</code>,
and as far as we could tell our user was indeed using the most recent version available for their
distribution &mdash; <code>1.4.25-2ubuntu2.1</code>. This version was released on November 3rd, and we could see from our logs that
<code>memcached</code> got upgraded that same day.</p>

<p>How did it happen without them knowing about it? The only thing unique about
their configuration was that they&rsquo;re running the recently released Ubuntu 16.10 (Yakkety
Yak)<sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup>. </p>

<p>We dug around, and set up some test Yakkety boxes, and
lo and behold: unattended upgrades is automatically enabled by default!</p>

<p>For those of you who are unaware, <code>unattended-upgrades</code> is a debian/ubuntu package that, well, does what it says on the
tin: it automatically upgrades your packages. The most common configuration, and the one enabled in 16.10, is to upgrade any packages that have a published security patch. Unattended upgrades does this by checking and installing any
updates from the <code>${distro_codename}-security</code> repository.</p>

<p>Ubuntu/debian has had this for years, but it simply was never turned on by
default. After a year of many
<a href="https://blog.appcanary.com/2016/vikhal-symantec.html">security</a>
<a href="https://blog.appcanary.com/2016/mirai-botnet-security-broken.html">fails</a>, this
news warmed the cockles of my heart and gave me hope for our future! And what&rsquo;s
even amazing is that they turned it on without any fanfare. </p>

<p>It&rsquo;s the quiet,
simple changes that provide the biggest wins.</p>

<p>Of course, there are reasons why administrators don&rsquo;t always want software to be upgraded without
their input. And if it does get updated, there are good reasons for knowing exactly what vulnerabilities are being patched when.
<a href="https://appcanary.com/?utm_source=blog&amp;utm_medium=web&amp;utm_campaign=unattended">Appcanary</a> exists in order to allow you to be notified
about security updates without automatically installing them, and to have
insight into what&rsquo;s going being installed if you are patching automatically.</p>

<p>But if you don&rsquo;t have the capacity to actively manage the packages on your
linux systems (and even if you do!), we implore you: set up <code>unattended-upgrades</code>!</p>

<p>Ubuntu enabling this by default is a great sign for the future.</p>

<h2 id="not-running-ubuntu-16-10">Not running Ubuntu 16.10?</h2>

<p>Here&rsquo;s how to turn on unattended upgrades</p>

<ul>
<li>Ansible: <a href="https://galaxy.ansible.com/jnv/unattended-upgrades/">jnv.unattended-upgrades</a></li>
<li>Puppet: <a href="https://forge.puppet.com/puppet/unattended_upgrades">puppet/unattended_upgrades</a></li>
<li>Chef: <a href="https://supermarket.chef.io/cookbooks/apt">apt</a></li>
<li><p>If you&rsquo;re using the server interactively: </p>

<p><code>sudo apt-get install unattended-upgrades &amp;&amp; sudo dpkg-reconfigure unattended-upgrades</code></p></li>
<li><p>Set up manually: <code>sudo apt-get install unattended-upgrades</code> and</p>

<ul>
<li><p>In <code>/etc/apt/apt.conf.d/20auto-upgrades</code>:</p>
<pre class="highlight plaintext"><code>APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Unattended-Upgrade "1";
</code></pre></li>
<li><p>In <code>/etc/apt/apt.conf.d/50unattended-upgrades</code></p>
<pre class="highlight plaintext"><code>// Automatically upgrade packages from these (origin, archive) pairs
Unattended-Upgrade::Allowed-Origins {    
// ${distro_id} and ${distro_codename} will be automatically expanded
    "${distro_id} ${distro_codename}-security";
};

// Send email to this address for problems or packages upgrades
// If empty or unset then no email is sent, make sure that you 
// have a working mail setup on your system. The package 'mailx'
// must be installed or anything that provides /usr/bin/mail.
//Unattended-Upgrade::Mail "root@localhost";

// Do automatic removal of new unused dependencies after the upgrade
// (equivalent to apt-get autoremove)
//Unattended-Upgrade::Remove-Unused-Dependencies "false";

// Automatically reboot *WITHOUT CONFIRMATION* if a 
// the file /var/run/reboot-required is found after the upgrade 
//Unattended-Upgrade::Automatic-Reboot "false";
</code></pre></li>
</ul></li>
</ul>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>16.10 is not a Long Term Support release. Regular Ubuntu releases
are supported for 9 months, while April releases on even years (i.e. 14.04,
16.04, etc&hellip;) are designated LTS, and are supported for 5 years. It&rsquo;s thus
more common to see 12.04, 14.04, and 16.04 in use on servers over other
Ubuntu releases. This particular user has a good reason for running 16.10.&nbsp;<a href="#fnref1" rev="footnote">&#8617;</a></p>
</li>

</ol>
</div>

</section>
<footer class='post-meta'>
<a href='/author/max-veytsman.html'>Max Veytsman</a>
on <a href='/tag/clojure.html'>Clojure</a>, <a href='/tag/programming.html'>Programming</a>, <a href='/tag/ruby.html'>Ruby</a>
<time class='post-date' datetime='2016-11-15'>
15 November 2016
</time>
</footer>
</article>
<article class='post'>
<header class='post-header'>
<h1 class='post-title'><a href="../2016/missing-clojure.html">We Left Clojure. Here's 5 Things I'll Miss.</a></h1>
<section class='post-meta'>
</section>
</header>
<section class='post-content'>
<p>On October 11th, Appcanary relied on about 8,500 lines of clojure code. On the
12th we were down to zero. We replaced it by adding another 5,700 lines of Ruby to our codebase. 
<a href="https://twitter.com/phillmv">Phill</a> will be discussing why we left, and what we learned both here and <a href="http://rubyconf.org/program#prop_19">at this year&rsquo;s RubyConf</a>. For now, I want to talk about what I&rsquo;ll miss.</p>

<h3 id="1-the-joy-of-lisp">1) The joy of Lisp</h3>

<p><a href="https://xkcd.com/297/"><img alt="XKCD #297" src="http://imgs.xkcd.com/comics/lisp_cycles.png" /></a></p>

<p>There&rsquo;s something magical about writing lisp. Alan Kay called it the greatest
single programming language ever devised. Paul Graham called it a
secret weapon. You can find tens of thousands
of words on the elegant, mind-expanding powers of lisp<sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup>. I don&rsquo;t think
my version of the Lisp wizardry blog post would be particularly original or
unique, so if you want to know more about the agony and ecstasy of wielding
parenthesis, read <a href="http://paulgraham.com/avg.html">Paul Graham</a>.</p>

<p>What&rsquo;s great about Clojure is that while Ruby
<a href="http://www.randomhacks.net/2005/12/03/why-ruby-is-an-acceptable-lisp/">might be an acceptable lisp</a>,
and lisp might
<a href="http://steve-yegge.blogspot.ca/2006/04/lisp-is-not-acceptable-lisp.html">not be an acceptable lisp</a>,
Clojure is a more than acceptable lisp. If we avoid the minefield of type
systems, Clojure addresses the other 4 problems Steve Yegge discusses in the previous link<sup id="fnref2"><a href="#fn2" rel="footnote">2</a></sup>.</p>

<h3 id="2-immutability">2) Immutability</h3>

<p>The core data structures in clojure are immutable. If I define <code>car</code> to be <code>&quot;a dirty van&quot;</code>,
nothing can ever change that. I can name some other thing <code>car</code> later, but
anything referencing that first <code>car</code> will always be referencing <code>&quot;a dirty van&quot;</code>.</p>

<p>This is great for a host of reasons. For one, you get parallelization for free &mdash;
since nothing will mutate your collection, mapping or reducing some function
over it can be hadooped out to as many clouds as you want without changing your
algorithms.</p>

<p>It&rsquo;s also much easier to can reason about your code. There&rsquo;s a famous quote by Larry Wall:</p>

<blockquote>
<p>[Perl] would prefer that you stayed out of its living room because you weren&rsquo;t
invited, not because it has a shotgun.</p>
</blockquote>

<p>He was talking about private methods, but the same is true for mutability in most languages. You call some method and who knows if it mutated a value you were using? You would prefer it not to, but you have no shotgun, and frankly it&rsquo;s so easy to mutate state without even knowing that you are. Consider Python:</p>
<pre class="highlight python"><code><span class="n">str1</span> <span class="o">=</span> <span class="s">"My name "</span>
<span class="n">str2</span> <span class="o">=</span> <span class="n">str1</span>
<span class="n">str1</span> <span class="o">+=</span> <span class="s">"is Max"</span>
<span class="k">print</span> <span class="n">str1</span>
<span class="c"># "My name is Max"</span>
<span class="k">print</span> <span class="n">str2</span>
<span class="c"># "My name"</span>

<span class="n">list1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">list2</span> <span class="o">=</span> <span class="n">list1</span>
<span class="n">list1</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="k">print</span> <span class="n">list1</span>
<span class="c"># [1, 2, 3, 4, 5]</span>
<span class="k">print</span> <span class="n">list2</span>
<span class="c"># [1, 2, 3, 4, 5]</span>
</code></pre>

<p>Calling <code>+=</code> on a string returned a new one, while calling <code>+=</code> on a list
mutated it in place! I have to remember which types are mutable, and whether
<code>+=</code> will give me a new object or mutate the existing one depending on its type.
Who knows what might happen when you start passing your variables by reference
to somewhere else?</p>

<p>Not having the choice to mutate state is as liberating as getting rid of your Facebook account.</p>

<h3 id="3-data-first-programming">3) Data first programming</h3>

<p>Walking away from object-oriented languages is very freeing. </p>

<p>I want to design a model for the game of poker. I start by listing the
nouns<sup id="fnref3"><a href="#fn3" rel="footnote">3</a></sup>: &ldquo;card&rdquo;, &ldquo;deck&rdquo;, &ldquo;hand&rdquo;, &ldquo;player&rdquo;, &ldquo;dealer&rdquo;, etc. Then I
think of the verbs, &ldquo;deal&rdquo;, &ldquo;bet&rdquo;, &ldquo;fold&rdquo;, etc. </p>

<p>Now what?
<a href="http://stackoverflow.com/questions/19553838/oop-design-quesiton-with-a-card-game">Here&rsquo;s</a>
a typical StackOverflow question demonstrating the confusion that comes with
designing like this. Is the dealer a kind of player or a separate class? If
players have hands of cards, how does the deck keep track of what cards are
left? </p>

<p>At the end of the day, the work of programming a poker game is codifying all of
the actual rules of the game, and these will end up in a <code>Game</code> singleton that
does most of the work anyway. </p>

<p>If you start by thinking about data and the functions that operate on it,
there&rsquo;s a natural way to solve hard problems from the top-down, which lets you quickly iterate your
design (see below). You have some data structure that represents the game
state, a structure representing possible actions a player can take, and a
function to transform a game state and an action into the next game state. That
function encodes the actual rules of poker (defined in lots of other, smaller
functions).</p>

<p>I find this style of programming very natural and satisfying. Of course, you can
do this in any language; but I find Clojure draws me towards it, while OO
languages push me away from it.</p>

<h3 id="4-unit-testing">4) Unit Testing</h3>

<p>The majority of your code is made up of pure functions. A pure function is one
which always gives the same output for a given input &mdash; doesn&rsquo;t that sound
easy to test? Instead of setting up test harnesses databases and mocks, you just
write tests for your functions.</p>

<p>Testing the edges of your code that talk to the outside world requires mocking,
of course, and integration testing is never trivial. But the first thing you want to
test is the super-complicated piece of business logic deep in your
codebase. The business logic your business depends on, like for instance computing
whether your version of OpenSSL is vulnerable to HeartBleed. </p>

<p>Clojure pushes you
to make that bit of code a pure function that&rsquo;s testable without setting
up complicated state.</p>

<h3 id="5-refactoring">5) Refactoring</h3>

<p>Here&rsquo;s a typical clojure function</p>
<pre class="highlight clojure"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">]</span><span class="w">
  </span><span class="c1">;; some code here
</span><span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">c</span><span class="w"> </span><span class="p">(</span><span class="nf">some-function</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)]</span><span class="w">
    </span><span class="c1">;; a ton of 
</span><span class="w">    </span><span class="c1">;; complicated code here
</span><span class="p">)))</span><span class="w">
</span></code></pre>

<p>In lisp-speak, a parenthesized block is called a &ldquo;form&rdquo;. The <code>foo</code> form is the outer form, and it contains the <code>let</code> form, which ostensibly contains other forms that do complicated things.</p>

<p>I know that all the complicated code inside of the <code>let</code> form isn&rsquo;t going to
mutate any state, and that it&rsquo;s only dependent on the <code>a</code> and <code>b</code> variables. This means that
refactoring this code out into its own functions is as trivial as selecting
everything between two matching parentheses and cutting and pasting it out. If
you have an editor that supports paredit-style navigation of lisp forms, you can
rearrange code at lightning speed.</p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>My favourite essay of this ilk is Mark Tarver&rsquo;s melancholy
<a href="http://www.shenlanguage.org/lambdassociates/htdocs/blog/bipolar.htm">The Bipolar Lisp Programmer</a>.
He describes lisp as a language designed by and for brilliant failures. Back
in university, I ate this shit up. My grades were obvious evidence of half the
requirement of being a lisp programmer.&nbsp;<a href="#fnref1" rev="footnote">&#8617;</a></p>
</li>

<li id="fn2">
<p>I&rsquo;m aware that clojure&rsquo;s <code>gensym</code> does not a hygenic macro system
make. But, if you have strong opinions on hygenic macros as they relate to
acceptable lisps, this article might not be for you.&nbsp;<a href="#fnref2" rev="footnote">&#8617;</a></p>
</li>

<li id="fn3">
<p>For the record, I know that this isn&rsquo;t the &ldquo;right&rdquo; way to design OO
programs, but the fact that I have to acknowledge this proves my point.&nbsp;<a href="#fnref3" rev="footnote">&#8617;</a></p>
</li>

</ol>
</div>

</section>
<footer class='post-meta'>
<a href='/author/max-veytsman.html'>Max Veytsman</a>
on <a href='/tag/clojure.html'>Clojure</a>, <a href='/tag/programming.html'>Programming</a>, <a href='/tag/ruby.html'>Ruby</a>
<time class='post-date' datetime='2016-11-07'>
07 November 2016
</time>
</footer>
</article>
<article class='post'>
<header class='post-header'>
<h1 class='post-title'><a href="../2016/slippery-exception-clojure-ruby.html">Slippery exceptions in Clojure and Ruby</a></h1>
<section class='post-meta'>
</section>
</header>
<section class='post-content'>
<p>Recently I spent a couple of hours banging my head against code that looks like this:</p>
<pre class="highlight clojure"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">parse-file</span><span class="w">
  </span><span class="p">[</span><span class="n">contents</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">remove</span><span class="w"> </span><span class="nb">nil?</span><span class="w">
          </span><span class="p">(</span><span class="nf">code-that</span><span class="w"> </span><span class="n">throws-an-exception</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">consume-manifest</span><span class="w">
  </span><span class="p">[</span><span class="n">contents</span><span class="w"> </span><span class="n">kind</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">try+</span><span class="w">
    </span><span class="p">(</span><span class="nf">parse-file</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span><span class="w">

    </span><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="n">java.lang.Exception</span><span class="w"> </span><span class="n">e</span><span class="w">
      </span><span class="p">(</span><span class="nf">throw+</span><span class="w"> </span><span class="p">{</span><span class="no">:type</span><span class="w"> </span><span class="no">::bad-parse</span><span class="w"> </span><span class="no">:message</span><span class="w"> </span><span class="s">"Invalid file."</span><span class="p">}))))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">check</span><span class="w">
  </span><span class="p">[</span><span class="n">file</span><span class="w"> </span><span class="n">kind</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">try+</span><span class="w">
    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">artifacts</span><span class="w"> </span><span class="p">(</span><span class="nf">consume-manifest</span><span class="w"> </span><span class="p">(</span><span class="nb">slurp</span><span class="w"> </span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="n">kind</span><span class="p">]</span><span class="w">
      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">not-empty</span><span class="w"> </span><span class="n">artifacts</span><span class="p">)</span><span class="w">
        </span><span class="err">…</span><span class="w"> </span><span class="n">etc</span><span class="w">
</span></code></pre>

<p>And much to my surprise, I kept getting the kind of exception <code>parse-file</code> generates deep within the <code>check</code> function, right up against <code>(not-empty artifacts)</code>.</p>

<p>I&rsquo;ve grown somewhat used to Clojure exceptions being unhelpful, but this was taking the cake. Coming from Ruby and pretty much every other language, this brushed up rudely against my expectations. </p>

<p>You can tell that exceptions in Clojure are unloved, given how cumbersome handling them natively is. We&rsquo;d had some trouble in the past getting <a href="https://github.com/scgilardi/slingshot">slingshot</a> to behave properly, so I zero&#39;ed in on there. Don&rsquo;t all exceptions in Java descend from <code>Exception</code>?</p>

<p>Stepping through <code>check</code> in the <a href="cursive-ide.com">Cursive</a> debugger, I could see that the exception generated was a pure java exception, not a slingshot exception generated by <code>throw+</code> in <code>consume-manifest</code>. This meant that the exception was slipping straight through uncaught. But calling <code>consume-manifest</code> directly in my repl was causing it to work as intended.</p>

<p>What the hell was going on?</p>

<p><a href="https://twitter.com/mveytsman">Max</a> took one look at it and set me straight. &ldquo;Oh. <a href="https://clojuredocs.org/clojure.core/remove"><code>remove</code></a> is lazy, so the exception isn&rsquo;t being throw until the lazy sequence is accessed.&rdquo;</p>

<p>Excuse me? I had an angry expression on my face. He looked sheepish.</p>

<p>&ldquo;How else would a lazy data structure work?&rdquo;</p>

<p>Well. I would expect a <code>catch java.lang.Exception</code> to <em>catch every exception</em>.</p>

<p>&ldquo;Right, well, hear me out. What if you had the following Ruby?&rdquo;</p>
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">lazy_parse</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
  <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">filename</span><span class="p">).</span><span class="nf">each_line</span><span class="p">.</span><span class="nf">each_with_index</span><span class="p">.</span><span class="nf">lazy</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
    <span class="k">raise</span> <span class="s2">"You can't catch me, I'm the exception man"</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">5</span>
    <span class="n">line</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">consume_file</span>
  <span class="k">begin</span>
    <span class="n">lazy_parse</span><span class="p">(</span><span class="s2">"Gemfile.lock"</span><span class="p">)</span>
  <span class="k">rescue</span>
    <span class="nb">puts</span> <span class="s2">"Woops, an exception. Good thing we caught it."</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">file</span> <span class="o">=</span> <span class="n">consume_file</span>
<span class="nb">puts</span> <span class="n">file</span><span class="p">.</span><span class="nf">first</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre>

<p>(Did you know that Ruby has had <a href="http://railsware.com/blog/2012/03/13/ruby-2-0-enumerablelazy/">lazy enumerables</a> for almost four years now? Worth reading <a href="http://patshaughnessy.net/2013/4/3/ruby-2-0-works-hard-so-you-can-be-lazy">Shaughnessy as well</a>.)</p>

<p>That shut me up good. And in case you were wondering, the stack trace is also useless in Ruby; there simply isn&rsquo;t any context for it to preserve. Frankly, I&rsquo;ve just never had to think about lazy data structures in Rubyland; they&rsquo;ve not been super popular. </p>

<p>It&rsquo;s hard to reason about this. I want to write wrapper functions that make my code safe to consume downstream. This isn&rsquo;t feasible for any functions iterating over potentially infinite lazy sequences, but fortunately for us we need to fit this file into memory anyways. In Ruby we&rsquo;d have to forcibly iterate over every element of the sequence and check for exceptions, but Clojure makes this easy with <a href="https://clojuredocs.org/clojure.core/doall"><code>doall</code></a>:</p>
<pre class="highlight clojure"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">parse-file</span><span class="w">
  </span><span class="p">[</span><span class="n">contents</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">doall</span><span class="w"> </span><span class="p">(</span><span class="nb">remove</span><span class="w"> </span><span class="nb">nil?</span><span class="w">
                 </span><span class="p">(</span><span class="nf">code-that</span><span class="w"> </span><span class="n">throws-an-exception</span><span class="p">))))</span><span class="w">
</span></code></pre>

<p>And now, things behave as intended.</p>

</section>
<footer class='post-meta'>
<a href='/author/phillip-mendonca-vieira.html'>Phillip Mendonça-Vieira</a>
on <a href='/tag/clojure.html'>Clojure</a>, <a href='/tag/ruby.html'>Ruby</a>, <a href='/tag/programming.html'>Programming</a>, <a href='/tag/bugs.html'>Bugs</a>, <a href='/tag/developer-diary.html'>Developer Diary</a>
<time class='post-date' datetime='2016-02-16'>
16 February 2016
</time>
</footer>
</article>
<nav class='pagination' role='pagination'>
<span class='page-number'>Page 1 of 1</span>
</nav>


</main>

<footer class='site-footer clearfix'>
<section class='copyright'>
<a href='/'>Appcanary</a>
&copy;
2017
</section>
<section class='poweredby'>
</section>
</footer>
</div>
<script src="//blog.appcanary.com/javascripts/application.js"></script>
<script type="text/javascript">
 /* <![CDATA[ */
 var google_conversion_id = 928841383;
 var google_custom_params = window.google_tag_params;
 var google_remarketing_only = true;
 /* ]]> */
</script>

<script type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js">
</script>
<noscript>
    <div style="display:inline;">
        <img height="1" width="1" style="border-style:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/928841383/?value=0&amp;guid=ON&amp;script=0"/>
    </div>
</noscript>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61163522-3', 'auto');
  ga('send', 'pageview');

</script>

<!-- Twitter universal website tag code -->
<script>
 !function(e,n,u,a){e.twq||(a=e.twq=function(){a.exe?a.exe.apply(a,arguments):
                                               a.queue.push(arguments);},a.version='1',a.queue=[],t=n.createElement(u),
                            t.async=!0,t.src='//static.ads-twitter.com/uwt.js',s=n.getElementsByTagName(u)[0],
                            s.parentNode.insertBefore(t,s))}(window,document,'script');
 // Insert Twitter Pixel ID and Standard Event data below
 twq('init','nve06');
 twq('track','PageView');
</script>
<!-- End Twitter universal website tag code -->

<!-- Facebook Pixel Code -->
<script>
 !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
                                                             n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
   n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
   t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
                                                                          document,'script','https://connect.facebook.net/en_US/fbevents.js');
 fbq('init', '1378208595579873'); // Insert your pixel ID here.
 fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
            src="https://www.facebook.com/tr?id=1378208595579873&ev=PageView&noscript=1"
          /></noscript>
<!-- DO NOT MODIFY -->
<!-- End Facebook Pixel Code -->

<script src="//load.sumome.com/" data-sumo-site-id="84b9887b8850f6f993594d381e10132f5c8b9df030857e91e24aae7626813e00" async="async"></script>

</body>
</html>
