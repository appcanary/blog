<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/stylesheets/application.css" rel="stylesheet" />
    <link href="/images/favicon.ico" rel="icon" type="image/ico" />

      <title>Appcanary - Improve Your Security: Port Scan Yourself</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body>
    <script src="//use.typekit.net/dkz5zwp.js"></script>
<script>try{Typekit.load({ async: false });}catch(e){}</script>


    <div class="topbar"></div>
    <div id="header">
      <div class="preamble">
        <a href="https://blog.appcanary.com"><img class="logo" src="/images/appcanary.png" alt="Appcanary logo"></a>
        <p>
          <b><a href="https://appcanary.com">Appcanary</a></b> makes sure you never run vulnerable software on your servers.
          <br/>
          Like our blog? Subscribe to our <a href="https://appcanary.us10.list-manage.com/subscribe?u=303b378f377508300c0b5469a&id=dc58e8f56f">newsletter</a> or <a href="https://podcast.appcanary.com">podcast</a>.<br/>
          Browse the <a href="/archive.html">archive</a>, or follow us on <a href="https://twitter.com/appcanary">twitter</a>, <a href="https://github.com/appcanary">github</a> or <a href="/feed.xml">rss</a>.
        </p>
      </div>
    </div>

      <section>
    <div class="entry">
      <div class="post">
        <h1 class="title"><a href="/2017/improve-security-port-scan-yourself.html">Improve Your Security: Port Scan Yourself</a></h1>
        <div class="published-tags">By <span class="author"><a href="/author/max-veytsman.html">Max Veytsman</a></span> |
          <span class="date">January 20, 2017</span> on <a href="/tags/security.html">Security</a>, <a href="/tags/programming.html">Programming</a>, <a href="/tags/network.html">Network</a></div>

        <p>Ransomware crews are no longer satisfied <a href="https://www.wired.com/2016/03/ransomware-why-hospitals-are-the-perfect-targets/">shutting down hospitals</a> and are now also going after hip tech startups. Last week, a professional crew got involved in <a href="https://www.bleepingcomputer.com/news/security/mongodb-apocalypse-professional-ransomware-group-gets-involved-infections-reach-28k-servers/">ransoming MongoDB instances</a>, and some 28,000 servers were compromised and held for Bitcoin.</p>

<p>The &ldquo;attack&rdquo; is so simple it barely deserves the name. The crew scans the internet looking for open and unsecured instances of MongoDB. When they find one, they log in and steal the data. The victims must pay Bitcoin to get their data back. To save on storage costs, sometimes the crew just deletes the data without bothering to save it &mdash; and the mark ends up paying for nothing. Even honor among thieves can&rsquo;t survive the harsh realities of 21st century globalized late cyber-capitalism.</p>

<p>When reading about these attacks, there is a strong temptation blame the victim. Hospitals were at fault because of their antiquated IT departments: huge, sclerotic fiefdoms incapable of moving past Windows 98. We all know that MongoDB <a href="http://cryto.net/~joepie91/blog/2015/07/19/why-you-should-never-ever-ever-use-mongodb/">sucks</a>, and that <a href="http://www.catb.org/jargon/html/story-of-mel.html">Real Programmers</a> would never be caught dead using it. Why, they probably <em>deserved</em> to get hacked!</p>

<p>Don&rsquo;t do it. As I&rsquo;ve said before, victim-blaming in security is a <a href="https://blog.appcanary.com/2016/mirai-botnet-security-broken.html">trap that must be avoided</a>. Attacks are varied and always changing; best practices can be indistinguishable from cargo cults, and default configurations seem almost designed to foil you.</p>

<p>In this case, MongoDB apparently ships without any authentication, listening to the whole wide world. No wonder so many instances got hacked!</p>

<h2 id="howto-not-get-hacked">HOWTO not get hacked</h2>

<p>Basically, you should have as little as possible accessible to the outside world. Set up a firewall. This tweet sums up the idea best:</p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">If Postgres, MySQL, memcached, redis, etc responds to commands from outside the VPN/firewall/etc, assume you will lose your deployment.</p>&mdash; Patrick McKenzie (@patio11) <a href="https://twitter.com/patio11/status/818728480661590018">January 10, 2017</a></blockquote>

<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>If you&rsquo;re anything like me, the first thought when confronted with that tweet is: &ldquo;is my firewall actually working right?&rdquo; Would you bet money that you know what ports are open on a given server in your fleet?</p>

<h3 id="enter-nmap">Enter Nmap</h3>

<p><img src="/images/trinity_nmap.jpg" title="Nmap as used in The Matrix" alt="trinity using Nmap" />
<em>Nmap as used in The Matrix</em></p>

<p><a href="https://nmap.org/">Nmap</a> is an incredibly powerful tool that&rsquo;s <a href="https://nmap.org/movies/">synonymous</a> with port scanning. A port scanner is a program that checks to see what network ports are open on a computer.</p>

<p>Here&rsquo;s what scanning <a href="https://appcanary.com">appcanary.com</a> with default settings from my work computer looks like:</p>
<pre class="highlight plaintext"><code>$ nmap appcanary.com

Starting Nmap 7.12 ( https://nmap.org ) at 2017-01-16 12:57 EST
Nmap scan report for appcanary.com (45.55.197.253)
Host is up (0.030s latency).
Not shown: 993 closed ports
PORT    STATE    SERVICE
22/tcp  open     ssh
25/tcp  filtered smtp
80/tcp  open     http
135/tcp filtered msrpc
139/tcp filtered netbios-ssn
443/tcp open     https
445/tcp filtered microsoft-ds
</code></pre>

<p>You&rsquo;ll see that 22, 80, and 443 are open. This is because we listen on SSH, HTTP and HTTPS. There are also a bunch of filtered ports. This is because some router or firewall between me and appcanary is blocking that port so it&rsquo;s not clear whether it&rsquo;s open or closed. </p>

<p>Running the same scan from a random<sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup> Digital Ocean box gives me the true result without the intermediate network filtering.</p>
<pre class="highlight plaintext"><code>Starting Nmap 5.21 ( http://nmap.org ) at 2017-01-16 13:04 EST
Nmap scan report for appcanary.com (45.55.197.253)
Host is up (0.0012s latency).
Not shown: 997 closed ports
PORT    STATE SERVICE
22/tcp  open  ssh
80/tcp  open  http
443/tcp open  https
</code></pre>

<p>Nmap has a variety of <a href="https://nmap.org/book/man-port-scanning-techniques.html">scanning options</a>, but the most important thing to understand for TCP scans is the difference between SYN scanning and connect scanning.</p>

<p>If you&rsquo;ve ever tried to write a port scanner (which is a great exercise in network programming and concurrency), you&rsquo;ve probably tried to write a connect scanner. A connect scanner tries to connect to a port, and closes the connection after success. Nmap&rsquo;s most popular mode is SYN scanning. In SYN scanning, you send a SYN packet initiating the <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol#Connection_establishment">TCP handshake</a>. If you get an SYN-ACK back, the port is open, and you send a RST instead of an ACK as you would if you were actually connecting. This is &ldquo;stealthier&rdquo;, which doesn&rsquo;t matter as much for our purposes, and is more efficient. Unfortunately it requires nmap to be run as root because it needs raw access to the network interface.</p>

<p>You can specify a SYN scan with <code>nmap -sS</code>, and a connect scan with <code>nmap -sT</code>. By default nmap will prefer to do a SYN scan if it is able to.</p>

<p>By default, nmap will scan the top 1000 most common ports. You can specify a specific ports or a range with <code>-p</code>, i.e. <code>nmap -p22</code> will scan only port 22, and <code>nmap -p400-500</code> will scan ports 400 through 500. <code>nmap -p-</code> will scan the complete port range (1-65535).</p>

<h3 id="developer-port-scan-thyself">Developer, port scan thyself</h3>

<p>Regularly port scan yourself; it&rsquo;s the only way to be certain that your databases aren&rsquo;t listening to the outside world. Run Nmap against your servers, and make sure that only the ports you expect are open. </p>

<p>To make it easier, here&rsquo;s a script to do it for you. This will run Nmap, compare the output with predefined ports, and ping you on Slack if there&rsquo;s a mismatch. Run it on a cron job, so you can check on the regular.</p>

<script src="https://gist.github.com/mveytsman/7a3366e69401fae6e9a4f9eaf0d3f9b1.js"></script>

<h2 id="how-does-appcanary-fit-in">How does Appcanary fit in?</h2>

<p>Our mission is to help you do security basics right, so you can be free to worry about the hard stuff. We&rsquo;re building the <a href="https://appcanary.com">world&rsquo;s best patch management product</a> because we had a deep need for one ourselves, and it automated such a vital part of a security team&rsquo;s job.</p>

<p>When I started writing this article, I didn&rsquo;t realize how well it fit into what we&rsquo;re doing with patch management. To do security right, you need to implement systems and continuously verify they are working correctly. <a href="https://appcanary.com">Appcanary</a> helps you verify your patch management program, the script above helps you verify your firewall. Both without any bullshit.</p>

<h3 id="we-want-to-hear-from-you">We want to hear from you</h3>

<p>Did I convince you to port scan your systems after reading the article? Are you using the script above? Something else? Let me know: <a href="mailto:max@appcanary.com">max@appcanary.com</a>.</p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>If you&rsquo;re observant, you may have noticed that this version of nmap is much older than the one on my work computer. If you&rsquo;re really observant, you may have noticed that it has a <a href="https://appcanary.com/vulns/35319">vulnerability</a>.&nbsp;<a href="#fnref1" rev="footnote">&#8617;</a></p>
</li>

</ol>
</div>


      </div>
    </div>
  </section>


    <script type="text/javascript">
 /* <![CDATA[ */
 var google_conversion_id = 928841383;
 var google_custom_params = window.google_tag_params;
 var google_remarketing_only = true;
 /* ]]> */
</script>

<script type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js">
</script>
<noscript>
    <div style="display:inline;">
        <img height="1" width="1" style="border-style:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/928841383/?value=0&amp;guid=ON&amp;script=0"/>
    </div>
</noscript>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61163522-3', 'auto');
  ga('send', 'pageview');

</script>

<!-- Twitter universal website tag code -->
<script>
 !function(e,n,u,a){e.twq||(a=e.twq=function(){a.exe?a.exe.apply(a,arguments):
                                               a.queue.push(arguments);},a.version='1',a.queue=[],t=n.createElement(u),
                            t.async=!0,t.src='//static.ads-twitter.com/uwt.js',s=n.getElementsByTagName(u)[0],
                            s.parentNode.insertBefore(t,s))}(window,document,'script');
 // Insert Twitter Pixel ID and Standard Event data below
 twq('init','nve06');
 twq('track','PageView');
</script>
<!-- End Twitter universal website tag code -->

<!-- Facebook Pixel Code -->
<script>
 !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
                                                             n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
   n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
   t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
                                                                          document,'script','https://connect.facebook.net/en_US/fbevents.js');
 fbq('init', '1378208595579873'); // Insert your pixel ID here.
 fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
            src="https://www.facebook.com/tr?id=1378208595579873&ev=PageView&noscript=1"
          /></noscript>
<!-- DO NOT MODIFY -->
<!-- End Facebook Pixel Code -->

    
  </body>
</html>
